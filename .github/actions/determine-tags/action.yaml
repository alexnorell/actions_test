name: "Determine Image Tags"
description: "Determine Docker image tags based on inputs, version, branch, and base image name"
inputs:
  custom_tag:
    description: "Custom tag to use for the image (overrides VERSION)"
    required: false
    default: ""
  version:
    description: "Version of the image (e.g., 0.0.5, without the 'v')"
    required: true
  base_image:
    description: "Base image name for the Docker tags (e.g., 'roboflow/roboflow-inference-server-gpu')"
    required: true
  token:
    description: "GitHub token for accessing repository data"
    required: true
  force_push:
    description: "Force push the release tag (only outputs the version tag)"
    required: false
    default: "false"
outputs:
  image_tags:
    description: "Comma-separated list of Docker image tags"
    value: ${{ steps.image_tags.outputs.image_tags }}
runs:
  using: "composite"
  steps:
    - name: Determine Image Tags
      shell: bash
      id: image_tags
      run: |
        # Capture inputs
        CUSTOM_TAG="${{ inputs.custom_tag }}"
        VERSION="${{ inputs.version }}"
        BASE_IMAGE="${{ inputs.base_image }}"
        TOKEN="${{ inputs.token }}"
        FORCE_PUSH="${{ inputs.force_push }}"
        BRANCH="${{ github.ref_name }}"
        EVENT_NAME="${{ github.event_name }}"
        TARGET_BRANCH="${{ github.event.release.target_commitish }}"

        # Fetch the latest release tag
        if [ "$EVENT_NAME" == "release" ]; then
          LATEST_RELEASE=$(curl -s -H "Authorization: Bearer $TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest" | jq -r '.tag_name')
          echo "Fetched latest release: $LATEST_RELEASE"

          # Normalize versions: remove 'v' from the latest release tag
          NORMALIZED_LATEST_RELEASE=$(echo "$LATEST_RELEASE" | sed 's/^v//')
          echo "Normalized latest release: $NORMALIZED_LATEST_RELEASE"
        else
          LATEST_RELEASE=""
          NORMALIZED_LATEST_RELEASE=""
        fi

        # Initialize the tags
        IMAGE_TAGS=""

        # Logic for force_push
        if [ "$FORCE_PUSH" == "true" ]; then
          IMAGE_TAGS="$BASE_IMAGE:$VERSION"
        else
          # Logic for push events to main
          if [ "$EVENT_NAME" == "push" ] && [ "$BRANCH" == "main" ]; then
            IMAGE_TAGS="$BASE_IMAGE:main"
          fi

          # Logic for release events
          if [ "$EVENT_NAME" == "release" ]; then
            IMAGE_TAGS="$BASE_IMAGE:$VERSION"
            if [ "$VERSION" == "$NORMALIZED_LATEST_RELEASE" ]; then
              IMAGE_TAGS="$IMAGE_TAGS,$BASE_IMAGE:latest"
            fi
          fi
        fi

        # Echo the computed tags
        echo "Computed image tags: $IMAGE_TAGS"

        # Export the tags to outputs
        echo "image_tags=$IMAGE_TAGS" >> $GITHUB_OUTPUT
